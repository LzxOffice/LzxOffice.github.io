<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LzxAI - 智能对话助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Markdown 渲染库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 代码高亮库 -->
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css" rel="stylesheet">
    <!-- MathJax 用于渲染LaTeX公式 -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        // Tailwind 配置
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#0F172A',
                        accent: '#38BDF8',
                        dark: '#0F172A',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 0 10px rgba(22, 93, 255, 0.5);
            }
            .bg-gradient-tech {
                background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
            }
            .border-glow {
                box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .typing-animation::after {
                content: '';
                animation: typing 1.5s infinite;
            }
            @keyframes typing {
                0%, 100% { content: ''; }
                25% { content: '.'; }
                50% { content: '..'; }
                75% { content: '...'; }
            }
            /* Markdown 样式增强 */
            .markdown-content h1 {
                @apply text-2xl font-bold mt-4 mb-2 text-primary;
            }
            .markdown-content h2 {
                @apply text-xl font-bold mt-3 mb-2 text-primary/90;
            }
            .markdown-content h3 {
                @apply text-lg font-bold mt-2 mb-1 text-primary/80;
            }
            .markdown-content p {
                @apply my-2;
            }
            .markdown-content ul {
                @apply list-disc pl-6 my-2;
            }
            .markdown-content ol {
                @apply list-decimal pl-6 my-2;
            }
            .markdown-content blockquote {
                @apply border-l-4 border-primary/50 pl-4 py-1 my-2 bg-primary/5;
            }
            .markdown-content code {
                @apply bg-gray-800 px-1 py-0.5 rounded text-accent;
            }
            .markdown-content pre {
                @apply bg-gray-800 p-4 rounded-lg my-2 overflow-x-auto;
            }
            .markdown-content pre code {
                @apply bg-transparent p-0;
            }
            .markdown-content a {
                @apply text-accent hover:underline;
            }
            .markdown-content table {
                @apply border-collapse w-full my-4;
            }
            .markdown-content th, .markdown-content td {
                @apply border border-gray-700 px-4 py-2;
            }
            .markdown-content th {
                @apply bg-gray-800;
            }
        }
    </style>
</head>
<body class="bg-secondary text-light font-inter min-h-screen flex flex-col">
    <!-- 顶部导航 -->
    <header class="bg-dark/80 backdrop-blur-md border-b border-primary/20 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-primary to-accent flex items-center justify-center">
                    <i class="fa fa-brain text-white"></i>
                </div>
                <h1 class="text-xl font-bold text-white text-shadow">LzxAI</h1>
            </div>
            <div class="flex items-center gap-4">
                <button id="clearBtn" class="text-gray-400 hover:text-white transition-colors duration-300">
                    <i class="fa fa-trash-o mr-1"></i>清空对话
                
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-1 container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
        <!-- 对话历史侧边栏 -->
        <aside class="lg:w-64 w-full bg-dark/50 rounded-xl border border-primary/20 p-4 hidden lg:block">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-history mr-2 text-primary"></i>对话历史
            </h2>
            <div id="historyList" class="space-y-2 overflow-y-auto max-h-[calc(100vh-200px)] scrollbar-hide">
                <div class="text-gray-500 text-sm text-center py-4">暂无对话历史</div>
            </div>
        </aside>

        <!-- 对话区域 -->
        <div class="flex-1 flex flex-col gap-4">
            <!-- 对话容器 -->
            <div id="chatContainer" class="flex-1 bg-dark/50 rounded-xl border border-primary/20 p-4 overflow-y-auto scrollbar-hide">
                <div class="flex flex-col gap-6 py-2">
                    <!-- 欢迎消息 -->
                    <div class="flex gap-3 ai-message">
                        <div class="w-8 h-8 rounded-full bg-primary flex-shrink-0 flex items-center justify-center">
                            <i class="fa fa-robot text-white"></i>
                        </div>
                        <div class="bg-dark/80 rounded-xl p-4 flex-1 markdown-content">
                            <p>你好！我是 LzxAI，有什么需要帮助的吗？</p>
			    <p>更多产品信息请访问 <a href="https://lzxoffice.github.io">LZX 工作室官网</a>。</p>

                                                    </div>
                    </div>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="bg-dark/50 rounded-xl border border-primary/20 p-4">
                <form id="chatForm" class="flex flex-col gap-3">
                    <textarea 
                        id="messageInput" 
                        placeholder="输入你的问题，支持 Markdown 和 LaTeX 公式，按 Enter 发送信息" 
                        class="w-full bg-dark/80 border border-primary/30 rounded-lg p-3 focus:outline-none focus:border-primary border-glow resize-none transition-all duration-300 h-20"
                    ></textarea>
                    <div class="flex justify-between items-center">
                                                <button 
                            type="submit" 
                            class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 border-glow"
                        >
                            <i class="fa fa-paper-plane"></i>
                            <span>发送</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark/80 border-t border-primary/20 py-4">
        <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
            <p>LzxAI  | © 2025 LZX 工作室</p>
        </div>
    </footer>

    <script>
        // 全局变量
        let conversationHistory = [];
        let isLoading = false;
        
        // DOM 元素
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const chatContainer = document.getElementById('chatContainer');
        const clearBtn = document.getElementById('clearBtn');
        const themeToggle = document.getElementById('themeToggle');
        const historyList = document.getElementById('historyList');
        
        const API_KEY = 'cc153b06cc1740e489aaa143e4c0a30d.dB64GZ1WEedC4ahh'
        const API_URL = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
        
        // 初始化Marked和MathJax
        document.addEventListener('DOMContentLoaded', () => {
            // 配置marked解析器
            marked.setOptions({
                highlight: (code, lang) => {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });
            
            // 自动聚焦输入框
            messageInput.focus();
            
            // 监听表单提交
            chatForm.addEventListener('submit', handleSubmit);
            
            // 监听清空按钮
            clearBtn.addEventListener('click', clearChat);
            
            // 监听主题切换
            themeToggle.addEventListener('click', toggleTheme);
            
            // 监听回车发送（Shift+回车换行）
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSubmit(e);
                }
            });
            
            // 初始化MathJax
            window.MathJax = {
                tex: {
                    inlineMath: [['\\(', '\\)'], ['$', '$']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']],
                    processEscapes: true
                },
                svg: {
                    fontCache: 'global'
                },
                startup: {
                    typeset: false // 手动触发渲染，避免重复渲染
                }
            };
        });
        
        // 处理表单提交
        async function handleSubmit(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message || isLoading) return;
            
            // 清空输入框
            messageInput.value = '';
            
            // 添加用户消息到界面（渲染Markdown）
            addMessageToChat(message, 'user');
            
            // 添加到对话历史
            conversationHistory.push({
                role: 'user',
                content: message
            });
            
            // 更新历史列表
            updateHistoryList();
            
            // 显示加载状态
            isLoading = true;
            const loadingMessage = addLoadingMessage();
            
            try {
                // 调用 API 获取响应
                const response = await fetchGLMAPI(conversationHistory);
                
                // 移除加载状态
                loadingMessage.remove();
                isLoading = false;
                
                // 添加 AI 响应到界面（渲染Markdown和LaTeX）
                addMessageToChat(response, 'ai');
                
                // 添加到对话历史
                conversationHistory.push({
                    role: 'assistant',
                    content: response
                });
                
            } catch (error) {
                // 移除加载状态
                loadingMessage.remove();
                isLoading = false;
                
                // 显示错误消息
                addMessageToChat(`抱歉，发生了错误：${error.message}`, 'ai', true);
                console.error('API 请求错误:', error);
            }
            
            // 滚动到底部
            scrollToBottom();
        }
        
        // 调用 GLM-4-flash API
        async function fetchGLMAPI(messages) {
            const requestBody = {
                model: "glm-4-flash",
                messages: messages,
                temperature: 0.7,
                stream: false
            };
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `HTTP 错误: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }
        
        // 添加消息到聊天界面（支持Markdown和LaTeX渲染）
        function addMessageToChat(content, sender, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex gap-3 ${sender}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full ${sender === 'user' ? 'bg-accent' : 'bg-primary'} flex-shrink-0 flex items-center justify-center`;
            avatar.innerHTML = sender === 'user' 
                ? '<i class="fa fa-user text-white"></i>' 
                : '<i class="fa fa-robot text-white"></i>';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `bg-dark/80 rounded-xl p-4 flex-1 markdown-content ${isError ? 'text-red-400' : ''}`;
            
            // 渲染Markdown
            if (isError) {
                contentDiv.textContent = content;
            } else {
                contentDiv.innerHTML = marked.parse(content);
                
                // 渲染LaTeX公式
                if (window.MathJax) {
                    MathJax.typesetPromise([contentDiv]).catch(err => console.error('MathJax渲染错误:', err));
                }
            }
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            chatContainer.querySelector('.flex-col').appendChild(messageDiv);
            
            // 高亮代码块
            highlightCodeBlocks(contentDiv);
            
            // 滚动到底部
            scrollToBottom();
        }
        
        // 代码高亮处理
        function highlightCodeBlocks(element) {
            const codeBlocks = element.querySelectorAll('pre code');
            codeBlocks.forEach(block => {
                hljs.highlightElement(block);
            });
        }
        
        // 添加加载中的消息
        function addLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex gap-3 ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = 'w-8 h-8 rounded-full bg-primary flex-shrink-0 flex items-center justify-center';
            avatar.innerHTML = '<i class="fa fa-robot text-white"></i>';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'bg-dark/80 rounded-xl p-4 flex-1';
            contentDiv.innerHTML = `<p class="typing-animation">正在思考</p>`;
            
            loadingDiv.appendChild(avatar);
            loadingDiv.appendChild(contentDiv);
            
            chatContainer.querySelector('.flex-col').appendChild(loadingDiv);
            
            // 滚动到底部
            scrollToBottom();
            
            return loadingDiv;
        }
        
        // 滚动到底部
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // 清空聊天
        function clearChat() {
            if (confirm('确定要清空所有对话吗？')) {
                // 保留欢迎消息
                const welcomeMessage = chatContainer.querySelector('.flex-col').firstElementChild;
                chatContainer.querySelector('.flex-col').innerHTML = '';
                chatContainer.querySelector('.flex-col').appendChild(welcomeMessage);
                
                // 重置对话历史
                conversationHistory = [];
                
                // 更新历史列表
                updateHistoryList();
                
                // 滚动到底部
                scrollToBottom();
            }
        }
        
        // 切换主题
        function toggleTheme() {
            document.body.classList.toggle('bg-light');
            document.body.classList.toggle('bg-secondary');
            document.body.classList.toggle('text-dark');
            document.body.classList.toggle('text-light');
            
            // 更新代码高亮样式
            document.querySelectorAll('pre').forEach(pre => {
                pre.classList.toggle('bg-gray-200');
                pre.classList.toggle('bg-gray-800');
            });
            
            const icon = themeToggle.querySelector('i');
            if (icon.classList.contains('fa-moon-o')) {
                icon.classList.replace('fa-moon-o', 'fa-sun-o');
            } else {
                icon.classList.replace('fa-sun-o', 'fa-moon-o');
            }
            
            // 重新渲染MathJax以适配主题
            if (window.MathJax) {
                MathJax.typesetPromise().catch(err => console.error('MathJax重新渲染错误:', err));
            }
        }
        
        // 更新历史列表
        function updateHistoryList() {
            if (conversationHistory.length === 0) {
                historyList.innerHTML = '<div class="text-gray-500 text-sm text-center py-4">暂无对话历史</div>';
                return;
            }
            
            historyList.innerHTML = '';
            
            // 只显示用户的问题作为历史项
            const userMessages = conversationHistory.filter(msg => msg.role === 'user');
            
            userMessages.forEach((msg, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'p-2 rounded-lg hover:bg-primary/10 cursor-pointer transition-colors duration-200 text-sm';
                historyItem.textContent = msg.content.length > 20 
                    ? msg.content.substring(0, 20) + '...' 
                    : msg.content;
                
                historyItem.addEventListener('click', () => {
                    // 这里可以添加点击历史项加载对应对话的逻辑
                    alert(`加载对话: ${msg.content}`);
                });
                
                historyList.appendChild(historyItem);
            });
        }
    </script>
</body>
</html>
